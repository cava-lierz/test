<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChatRoomUserServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mentara-server</a> &gt; <a href="index.source.html" class="el_package">com.mentara.service.impl</a> &gt; <span class="el_source">ChatRoomUserServiceImpl.java</span></div><h1>ChatRoomUserServiceImpl.java</h1><pre class="source lang-java linenums">package com.mentara.service.impl;

import com.mentara.dto.request.ChatRoomUserRequest;
import com.mentara.dto.response.ChatRoomUserResponse;
import com.mentara.entity.ChatRoom;
import com.mentara.entity.ChatRoomUser;
import com.mentara.entity.User;
import com.mentara.enums.ChatRoomType;
import com.mentara.repository.ChatRoomRepository;
import com.mentara.repository.ChatRoomUserRepository;
import com.mentara.repository.UserRepository;
import com.mentara.service.ChatRoomUserService;
import com.mentara.util.AvatarUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

import static com.mentara.enums.ChatRoomType.ANONYMOUS;

@Service
<span class="fc" id="L23">public class ChatRoomUserServiceImpl implements ChatRoomUserService {</span>
    @Autowired
    private ChatRoomUserRepository chatRoomUserRepository;
    @Autowired
    private ChatRoomRepository chatRoomRepository;
    @Autowired
    private UserRepository userRepository;

    @Override
    public void save(ChatRoomUser chatRoomUser){
<span class="fc" id="L33">        chatRoomUserRepository.save(chatRoomUser);</span>
<span class="fc" id="L34">    }</span>

    @Override
    public void deleteUser(Long id){
<span class="fc" id="L38">        ChatRoomUser user = chatRoomUserRepository.findById(id)</span>
<span class="fc" id="L39">                .orElseThrow(() -&gt; new RuntimeException(&quot;用户不存在&quot;));</span>

<span class="fc" id="L41">        user.setVersion(0);</span>
<span class="fc" id="L42">        save(user);</span>
<span class="fc" id="L43">    }</span>

    @Override
    public void quitRoom(Long id){
<span class="fc" id="L47">        ChatRoomUser user = chatRoomUserRepository.findById(id)</span>
<span class="fc" id="L48">                .orElseThrow(() -&gt; new RuntimeException(&quot;用户不存在&quot;));</span>

<span class="fc" id="L50">        user.setVersion(-1);</span>
<span class="fc" id="L51">        save(user);</span>
<span class="fc" id="L52">    }</span>

    @Override
    public ChatRoomUser getChatRoomUserByByChatRoomIdAndUserId(Long chatRoomId, Long userId){
<span class="fc" id="L56">        List&lt;ChatRoomUser&gt; users = chatRoomUserRepository.findByChatRoomIdAndUserId(chatRoomId, userId);</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (users.isEmpty()) {</span>
<span class="fc" id="L58">            throw new RuntimeException(&quot;User not found in chat room&quot;);</span>
        }

<span class="fc" id="L61">        return users.get(0);</span>
    }

    @Override
    public ChatRoomUserResponse addUserToRoom(ChatRoomUserRequest request) {
<span class="fc" id="L66">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(request.getChatRoomId())</span>
<span class="fc" id="L67">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
<span class="fc" id="L68">        User user = userRepository.findById(request.getUserId())</span>
<span class="pc" id="L69">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>
        
        // 检查用户是否已经在聊天室中
<span class="fc" id="L72">        List&lt;ChatRoomUser&gt; existingUsers = chatRoomUserRepository.findByChatRoomIdAndUserId(request.getChatRoomId(), request.getUserId());</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (!existingUsers.isEmpty()) {</span>
            // 如果用户已存在，返回第一个记录（清理重复记录）
<span class="fc" id="L75">            ChatRoomUser existingUser = existingUsers.get(0);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            if(existingUser.getVersion() == -1){</span>
<span class="nc" id="L77">                existingUser.setVersion(1);</span>
<span class="nc" id="L78">                save(existingUser);</span>
            }
            // 删除重复记录
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            for (int i = 1; i &lt; existingUsers.size(); i++) {</span>
<span class="nc" id="L82">                chatRoomUserRepository.delete(existingUsers.get(i));</span>
            }
<span class="fc" id="L84">            return toResponse(existingUser);</span>
        }


        
<span class="fc" id="L89">        ChatRoomUser chatRoomUser = new ChatRoomUser();</span>
<span class="fc" id="L90">        chatRoomUser.setChatRoom(chatRoom);</span>
<span class="fc" id="L91">        chatRoomUser.setUser(user);</span>
<span class="fc" id="L92">        chatRoomUser.setDisplayNickname(request.getDisplayNickname());</span>
        
        // 为匿名聊天室用户分配随机默认头像
<span class="fc" id="L95">        String displayAvatar = request.getDisplayAvatar();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (chatRoom.getType() == ChatRoomType.ANONYMOUS) {</span>
            // 匿名聊天室：为每个用户分配随机默认头像
<span class="nc" id="L98">            String uniqueKey = chatRoom.getId() + &quot;_&quot; + user.getId();</span>
<span class="nc" id="L99">            displayAvatar = AvatarUtils.generateRandomDefaultAvatar(uniqueKey);</span>
        }
<span class="fc" id="L101">        chatRoomUser.setDisplayAvatar(displayAvatar);</span>
        
<span class="fc" id="L103">        chatRoomUser.setVersion(1);</span>
<span class="fc" id="L104">        ChatRoomUser saved = chatRoomUserRepository.save(chatRoomUser);</span>
<span class="fc" id="L105">        return toResponse(saved);</span>
    }

    @Override
    public ChatRoomUserResponse getUserByRoomAndId(Long chatRoomId, Long id){
        // 先检查聊天室是否存在且未删除
<span class="fc" id="L111">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(chatRoomId)</span>
<span class="fc" id="L112">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
        
<span class="fc" id="L114">        ChatRoomUser user = chatRoomUserRepository.findByChatRoomIdAndId(chatRoomId, id);</span>
<span class="fc" id="L115">        return toResponse(user);</span>
    }

    @Override
    public boolean isInRoom(Long chatRoomId, Long userId){
        // 先检查聊天室是否存在且未删除
<span class="fc" id="L121">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(chatRoomId)</span>
<span class="fc" id="L122">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
        
<span class="fc" id="L124">        List&lt;ChatRoomUser&gt; users = chatRoomUserRepository.findByChatRoomIdAndUserId(chatRoomId, userId);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        boolean exists = !users.isEmpty();</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if(exists){</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">            return users.get(0).getVersion() &gt; 0;</span>
        }
<span class="nc" id="L129">        return false;</span>
    }

    @Override
    public ChatRoomUserResponse getUserFromRoom(Long chatRoomId, Long userId){
        // 先检查聊天室是否存在且未删除
<span class="fc" id="L135">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(chatRoomId)</span>
<span class="fc" id="L136">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
        
<span class="fc" id="L138">        List&lt;ChatRoomUser&gt; users = chatRoomUserRepository.findByChatRoomIdAndUserId(chatRoomId, userId);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (users.isEmpty()) {</span>
<span class="nc" id="L140">            throw new RuntimeException(&quot;User not found in chat room&quot;);</span>
        }
        // 返回第一个记录
<span class="fc" id="L143">        return toResponse(users.get(0));</span>
    }

    @Override
    public List&lt;ChatRoomUserResponse&gt; getUsersByRoom(Long chatRoomId) {
        // 先检查聊天室是否存在且未删除
<span class="fc" id="L149">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(chatRoomId)</span>
<span class="fc" id="L150">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
        
<span class="fc" id="L152">        List&lt;ChatRoomUser&gt; users = chatRoomUserRepository.findByChatRoomId(chatRoomId);</span>
<span class="fc" id="L153">        return users.stream().map(this::toResponse).collect(Collectors.toList());</span>
    }

    @Override
    public ChatRoomUserResponse joinRoom(Long chatRoomId, Long userId) {
        // 获取聊天室信息
<span class="fc" id="L159">        ChatRoom chatRoom = chatRoomRepository.findByIdAndIsDeletedFalse(chatRoomId)</span>
<span class="fc" id="L160">                .orElseThrow(() -&gt; new RuntimeException(&quot;ChatRoom not found or has been deleted&quot;));</span>
        
        // 获取用户信息
<span class="fc" id="L163">        User user = userRepository.findById(userId)</span>
<span class="pc" id="L164">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>
        
        
<span class="fc" id="L167">        ChatRoomUserRequest req = new ChatRoomUserRequest();</span>
<span class="fc" id="L168">        req.setChatRoomId(chatRoomId);</span>
<span class="fc" id="L169">        req.setUserId(userId);</span>
        
        // 根据聊天室类型设置默认昵称和头像
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (chatRoom.getType().name().equals(&quot;ANONYMOUS&quot;)) {</span>
            // 匿名聊天室：使用默认匿名信息
<span class="nc" id="L174">            req.setDisplayNickname(&quot;&quot;);  // 空字符串，让toResponse方法生成默认匿名昵称</span>
            //req.setDisplayAvatar(&quot;&quot;);    // 空字符串，让toResponse方法使用默认头像
<span class="nc" id="L176">            String uniqueKey = chatRoomId + &quot;_&quot; + userId;</span>
<span class="nc" id="L177">            req.setDisplayAvatar(AvatarUtils.generateRandomDefaultAvatar(uniqueKey));</span>
<span class="nc" id="L178">        } else {</span>
            // 实名聊天室：使用用户真实信息
<span class="fc" id="L180">            req.setDisplayNickname(user.getNickname());</span>
<span class="fc" id="L181">            req.setDisplayAvatar(user.getAvatar());</span>
        }
        
<span class="fc" id="L184">        return addUserToRoom(req);</span>
    }

    private ChatRoomUserResponse toResponse(ChatRoomUser chatRoomUser) {
<span class="fc" id="L188">        ChatRoomUserResponse resp = new ChatRoomUserResponse();</span>
<span class="fc" id="L189">        resp.setChatRoomId(chatRoomUser.getChatRoom().getId());</span>
<span class="fc" id="L190">        resp.setChatRoomUserId(chatRoomUser.getId());  // 设置房间用户ID</span>
<span class="fc" id="L191">        resp.setVersion(chatRoomUser.getVersion());</span>
        
        // 获取聊天室类型
<span class="fc" id="L194">        boolean isAnonymousRoom = chatRoomUser.getChatRoom().getType().name().equals(&quot;ANONYMOUS&quot;);</span>
        
        // 处理显示昵称
<span class="fc" id="L197">        String displayNickname = chatRoomUser.getDisplayNickname();</span>
<span class="pc bpc" id="L198" title="1 of 4 branches missed.">        if (displayNickname == null || displayNickname.isEmpty()) {</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">            if (isAnonymousRoom) {</span>
                // 匿名聊天室：如果没有设置昵称，使用默认匿名昵称
<span class="nc" id="L201">                displayNickname = &quot;匿名用户&quot; + chatRoomUser.getId();</span>
            } else {
                // 实名聊天室：使用用户昵称
<span class="fc" id="L204">                displayNickname = chatRoomUser.getUser().getNickname();</span>
            }
        }
        // 如果用户已删除，显示&quot;已删除用户&quot;
<span class="pc bpc" id="L208" title="2 of 4 branches missed.">        if (chatRoomUser.getUser().getIsDeleted() != null &amp;&amp; chatRoomUser.getUser().getIsDeleted()) {</span>
<span class="nc" id="L209">            displayNickname = &quot;已删除用户&quot;;</span>
        }
<span class="fc" id="L211">        resp.setDisplayNickname(displayNickname);</span>
        
        // 处理显示头像
<span class="fc" id="L214">        String displayAvatar = chatRoomUser.getDisplayAvatar();</span>
<span class="pc bpc" id="L215" title="1 of 4 branches missed.">        if (displayAvatar == null || displayAvatar.isEmpty()) {</span>
            // 如果显示头像为空，根据聊天室类型处理
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (chatRoomUser.getChatRoom().getType() == ChatRoomType.ANONYMOUS) {</span>
                // 匿名聊天室：生成随机默认头像
<span class="nc" id="L219">                String uniqueKey = chatRoomUser.getChatRoom().getId() + &quot;_&quot; + chatRoomUser.getUser().getId();</span>
<span class="nc" id="L220">                displayAvatar = AvatarUtils.generateRandomDefaultAvatar(uniqueKey);</span>
<span class="nc" id="L221">            } else {</span>
                // 实名聊天室：使用用户头像
<span class="fc" id="L223">                displayAvatar = chatRoomUser.getUser().getAvatar();</span>
            }
        }
        // 如果用户已删除，使用默认头像
<span class="pc bpc" id="L227" title="2 of 4 branches missed.">        if (chatRoomUser.getUser().getIsDeleted() != null &amp;&amp; chatRoomUser.getUser().getIsDeleted()) {</span>
<span class="nc" id="L228">            displayAvatar = AvatarUtils.getDeletedUserAvatar();</span>
        }
        // 如果头像仍然为空，使用随机默认头像
<span class="pc bpc" id="L231" title="1 of 4 branches missed.">        if (displayAvatar == null || displayAvatar.isEmpty()) {</span>
<span class="fc" id="L232">            String uniqueKey = chatRoomUser.getChatRoom().getId() + &quot;_&quot; + chatRoomUser.getUser().getId();</span>
<span class="fc" id="L233">            displayAvatar = AvatarUtils.generateRandomDefaultAvatar(uniqueKey);</span>
        }
<span class="fc" id="L235">        resp.setDisplayAvatar(displayAvatar);</span>
        
<span class="fc" id="L237">        return resp;</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>