# Mentara 系统架构与启动流程

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                  │
│                    http://localhost:3000                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (React)                          │
│                    Port: 3000                                   │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐        │
│  │  Components  │  │  Pages        │  │  Services    │        │
│  │  - Header    │  │  - Home       │  │  - API       │        │
│  │  - Sidebar   │  │  - Profile    │  │  - WebSocket │        │
│  │  - PostCard  │  │  - Community  │  │  - Chat      │        │
│  └──────────────┘  └───────────────┘  └──────────────┘        │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/WebSocket
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                      后端层 (Spring Boot)                       │
│                    Port: 8080 (/api)                            │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐        │
│  │ Controllers  │  │  Services     │  │  Repositories│        │
│  │ - User       │  │  - Auth       │  │  - JPA       │        │
│  │ - Post       │  │  - Post       │  │  - MongoDB   │        │
│  │ - Comment    │  │  - AI Chat    │  │  - Qdrant    │        │
│  │ - WebSocket  │  │  - Embedding  │  │  - Redis     │        │
│  └──────────────┘  └───────────────┘  └──────────────┘        │
└─────┬────────────────────┬──────────────────┬──────────────────┘
      │                    │                  │
      ↓                    ↓                  ↓
┌─────────────┐    ┌──────────────┐   ┌──────────────────────────┐
│  微服务层   │    │  微服务层    │   │      数据存储层          │
│             │    │              │   │                          │
│ BERT服务    │    │ Embedding服务│   │ ┌──────────────────────┐ │
│ Port: 8000  │    │ Port: 8081   │   │ │ MySQL (Port: 3306)   │ │
│             │    │              │   │ │ - 用户数据           │ │
│ ┌─────────┐ │    │ ┌──────────┐ │   │ │ - 帖子数据           │ │
│ │情感分析 │ │    │ │文本向量化│ │   │ │ - 关系数据           │ │
│ │抑郁检测 │ │    │ │Embedding │ │   │ └──────────────────────┘ │
│ └─────────┘ │    │ └──────────┘ │   │ ┌──────────────────────┐ │
│             │    │              │   │ │ MongoDB (Port:27017) │ │
│ FastAPI     │    │ C++ HTTP     │   │ │ - 聊天记录           │ │
│ Python 3.8+ │    │ GGML+llama   │   │ │ - 大文本数据         │ │
└─────────────┘    └──────────────┘   │ └──────────────────────┘ │
                                      │ ┌──────────────────────┐ │
                                      │ │ Qdrant (Port: 6333)  │ │
                                      │ │ - 向量存储           │ │
                                      │ │ - 语义搜索           │ │
                                      │ └──────────────────────┘ │
                                      │ ┌──────────────────────┐ │
                                      │ │ Redis (Port: 6379)   │ │
                                      │ │ - 缓存               │ │
                                      │ │ - Session            │ │
                                      │ └──────────────────────┘ │
                                      └──────────────────────────┘
```

## 🚀 启动流程

### 自动启动顺序

```
start-all.sh 执行流程:

1️⃣  环境检查
    ├─ 检查 Docker 是否安装
    ├─ 检查 Maven 是否安装
    ├─ 检查 Node.js 是否安装
    ├─ 检查 Python 是否安装
    └─ 检查端口是否被占用
    
2️⃣  启动数据库层 (并行启动)
    ├─ docker-compose up -d
    │   ├─ MySQL        → 等待端口 3306
    │   ├─ MongoDB      → 等待端口 27017
    │   ├─ Qdrant       → 等待端口 6333
    │   └─ Redis        → 等待端口 6379
    └─ 等待所有数据库就绪 (最多30秒)
    
3️⃣  启动微服务层 (并行启动)
    ├─ BERT服务
    │   ├─ 检查/创建 Python 虚拟环境
    │   ├─ 安装依赖 (首次)
    │   ├─ 加载 BERT 模型
    │   ├─ 启动 FastAPI (后台运行)
    │   └─ 健康检查: http://localhost:8000/docs
    │
    └─ Embedding服务
        ├─ 检查编译产物
        ├─ 编译 C++ 代码 (如需要)
        ├─ 启动 HTTP 服务器 (后台运行)
        └─ 健康检查: http://localhost:8081/health
    
4️⃣  启动后端服务
    ├─ mvn spring-boot:run (后台运行)
    ├─ Spring Boot 初始化
    │   ├─ 连接 MySQL
    │   ├─ 连接 MongoDB
    │   ├─ 连接 Qdrant
    │   ├─ 连接 Redis
    │   ├─ 初始化 WebSocket
    │   └─ 初始化缓存
    └─ 健康检查: http://localhost:8080/api/actuator/health
    
5️⃣  启动前端服务
    ├─ 检查 node_modules (首次 npm install)
    ├─ npm start (后台运行)
    ├─ Webpack 编译
    └─ 等待端口 3000 启动
    
✅  启动完成
    └─ 显示所有服务地址和状态
```

## 📊 服务依赖关系

### 依赖矩阵

| 服务 | 依赖项 | 可选依赖 |
|------|--------|----------|
| **前端** | 后端 | - |
| **后端** | MySQL, MongoDB, Qdrant, Redis | BERT, Embedding |
| **BERT** | - | - |
| **Embedding** | - | - |
| **MySQL** | - | - |
| **MongoDB** | - | - |
| **Qdrant** | - | - |
| **Redis** | - | - |

**说明**:
- 前端依赖后端，必须在后端启动后才能正常工作
- 后端的核心功能依赖所有数据库
- 微服务（BERT、Embedding）是可选的，后端可以优雅降级
- 数据库之间没有相互依赖

## 🔄 数据流向

### 用户操作流程

```
用户发帖流程:
┌──────┐    ┌──────┐    ┌──────┐    ┌─────────┐    ┌────────┐
│ 用户 │ → │ 前端 │ → │ 后端 │ → │ MySQL   │ → │ Redis  │
│      │   │      │   │      │   │ (帖子)  │   │ (缓存) │
└──────┘    └──────┘    └──┬───┘    └─────────┘    └────────┘
                           │
                           ├────→ BERT服务 (情感分析)
                           │
                           ├────→ Embedding服务 (向量化)
                           │
                           └────→ Qdrant (存储向量)
```

```
AI对话流程:
┌──────┐    ┌──────┐    ┌──────┐    ┌──────────┐
│ 用户 │ → │ 前端 │ → │ 后端 │ → │ DeepSeek │
│      │   │      │   │      │   │   API    │
└──────┘    └──────┘    └──┬───┘    └──────────┘
                           │
                           ├────→ MongoDB (聊天历史)
                           │
                           └────→ Redis (对话缓存)
```

```
语义搜索流程:
┌──────┐    ┌──────┐    ┌──────┐    ┌──────────┐
│ 用户 │ → │ 前端 │ → │ 后端 │ → │ Embedding│
│      │   │      │   │      │   │  服务    │
└──────┘    └──────┘    └──┬───┘    └──────────┘
                           │
                           ├────→ Qdrant (向量搜索)
                           │
                           └────→ MySQL (获取详情)
```

## 🔌 端口分配策略

### 端口规划

```
3000-3999: 前端服务
  ├─ 3000: React 开发服务器

8000-8999: 后端和微服务
  ├─ 8000: BERT 微服务 (Python FastAPI)
  ├─ 8080: 后端主服务 (Spring Boot)
  └─ 8081: Embedding 微服务 (C++)

6000-6999: 数据库服务
  ├─ 6333: Qdrant HTTP API
  ├─ 6334: Qdrant gRPC
  └─ 6379: Redis

其他标准端口:
  ├─ 3306: MySQL
  └─ 27017: MongoDB
```

## 📦 服务容器化

### Docker 服务配置

```yaml
# database/docker-compose.yml

services:
  mysql:      # 关系型数据库
    image: mysql:8.0
    ports: ["3306:3306"]
    volumes: ["./data/mysql:/var/lib/mysql"]
    
  mongodb:    # 文档数据库
    image: mongo:latest
    ports: ["27017:27017"]
    volumes: ["./data/mongodb:/data/db"]
    
  qdrant:     # 向量数据库
    image: qdrant/qdrant:latest
    ports: ["6333:6333", "6334:6334"]
    volumes: ["./data/qdrant:/qdrant/storage"]
    
  redis:      # 缓存数据库
    image: redis:7-alpine
    ports: ["6379:6379"]
    volumes: ["./data/redis:/data"]
```

## 🛠️ 技术栈

### 前端技术栈

```
React 18.2.0
├─ react-router-dom (路由)
├─ @stomp/stompjs (WebSocket)
├─ react-image-crop (图片裁剪)
└─ react-window (虚拟列表)
```

### 后端技术栈

```
Spring Boot 3.1.0 (Java 17)
├─ Spring Security (认证授权)
├─ Spring Data JPA (MySQL ORM)
├─ Spring Data MongoDB (MongoDB)
├─ Spring WebSocket (实时通信)
├─ Spring Cache (缓存)
├─ JWT (Token认证)
├─ Qdrant Client (向量搜索)
└─ WebFlux (HTTP客户端)
```

### 微服务技术栈

```
BERT服务:
├─ FastAPI (Web框架)
├─ Transformers (BERT模型)
├─ ONNX Runtime (CPU加速)
└─ Uvicorn (ASGI服务器)

Embedding服务:
├─ C++17
├─ llama.cpp (推理引擎)
├─ httplib (HTTP服务器)
└─ nlohmann/json (JSON处理)
```

## 🔒 安全架构

```
┌─────────────────────────────────────────────┐
│            安全层                           │
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  │
│  │  CORS   │  │   JWT    │  │  HTTPS   │  │
│  │ 跨域保护│  │ 认证授权 │  │ 传输加密 │  │
│  └─────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────┘
         │              │              │
         ↓              ↓              ↓
┌─────────────────────────────────────────────┐
│           应用层防护                        │
│  ┌─────────────┐  ┌─────────────────────┐  │
│  │ SQL注入防护 │  │  XSS/CSRF防护       │  │
│  │ - JPA参数化 │  │  - Spring Security  │  │
│  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────┘
         │              │
         ↓              ↓
┌─────────────────────────────────────────────┐
│          数据层安全                         │
│  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 密码加密    │  │  数据备份           │  │
│  │ - BCrypt    │  │  - 持久化卷         │  │
│  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────┘
```

## 📈 性能优化

### 缓存策略

```
三层缓存架构:

L1 缓存 (应用内存)
  └─ Spring Cache (@Cacheable)
      ├─ 用户信息
      ├─ 热点帖子
      └─ 标签数据

L2 缓存 (Redis)
  └─ 分布式缓存
      ├─ Session 数据
      ├─ API 响应缓存
      └─ 实时数据

L3 缓存 (数据库)
  └─ 查询缓存
      ├─ MySQL Query Cache
      └─ MongoDB WiredTiger Cache
```

### 连接池配置

```
HikariCP (MySQL):
  ├─ 最小连接: 10
  ├─ 最大连接: 50
  └─ 超时时间: 20s

MongoDB:
  ├─ 最小连接: 10
  ├─ 最大连接: 50
  └─ 空闲时间: 5min

Tomcat:
  ├─ 最大线程: 200
  ├─ 最小线程: 10
  └─ 最大连接: 8192
```

## 🔍 监控与日志

### 日志架构

```
logs/
├─ backend.log          # Spring Boot 日志
│   ├─ INFO: 业务日志
│   ├─ ERROR: 错误日志
│   └─ DEBUG: 调试日志
│
├─ bert_service.log     # BERT 微服务日志
│   └─ FastAPI 请求日志
│
├─ embedding_service.log # Embedding 服务日志
│   └─ C++ HTTP 服务日志
│
└─ frontend.log         # React 构建日志
    └─ Webpack 编译日志
```

### 健康检查端点

```
后端健康检查:
  └─ http://localhost:8080/api/actuator/health
      ├─ 数据库连接状态
      ├─ 磁盘空间
      └─ 内存使用

BERT服务:
  └─ http://localhost:8000/docs
      └─ FastAPI Swagger UI

Embedding服务:
  └─ http://localhost:8081/health
      └─ 简单健康响应

Qdrant:
  └─ http://localhost:6333/health
      └─ 向量数据库状态
```

## 🚦 服务状态机

```
[停止] ──start──> [启动中] ──ready──> [运行中] ──stop──> [停止]
   ↑                  │                    │
   │                  │                    │
   └────error─────────┴──────error────────┘
```

---

**更新日期**: 2025-10-06  
**版本**: 1.0.0



